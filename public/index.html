<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRLM Dashboard - Letter Tracking</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <style>
        body { margin: 0; padding: 0; }
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .main-content { flex: 1; }
        .footer { background-color: var(--primary-navy); color: white; text-align: center; padding: 1.5rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Navigation Header -->
        <header class="navbar">
            <div class="navbar-content">
                <div class="navbar-brand">
                    <div class="logo-section">
                        <h1>üèõÔ∏è TRLM</h1>
                        <div class="brand-text">
                            <h2>Tripura Rural Livelihood Mission</h2>
                            <p>Letter Tracking & Analytics Dashboard</p>
                        </div>
                    </div>
                </div>
                <nav class="navbar-menu">
                    <a href="/" class="nav-link active">üè† Dashboard</a>
                    <a href="/pages/data-table.html" class="nav-link">üìä Data Table</a>
                    <a href="/pages/analytics.html" class="nav-link">üìà Analytics</a>
                    <a href="/pages/warnings.html" class="nav-link">‚ö†Ô∏è Warnings</a>
                    <div id="admin-menu" class="admin-menu" style="display:none;">
                        <a href="/pages/admin.html" class="nav-link">üë§ Admin Panel</a>
                        <button class="nav-link logout-btn" onclick="handleLogout()">üö™ Logout</button>
                    </div>
                    <button id="login-btn" class="nav-link login-btn" onclick="openLoginModal()">üîê Login</button>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Login Modal -->
            <div id="loginModal" class="modal-overlay" style="display: none;">
                <div class="modal-box">
                    <div class="modal-header">
                        <h2>Admin Login</h2>
                        <button class="close-btn" onclick="closeLoginModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="loginForm" onsubmit="submitLogin(event)">
                            <div class="form-group">
                                <label for="username">Username:</label>
                                <input type="text" id="username" name="username" placeholder="TRLM_FarmLH" required>
                            </div>
                            <div class="form-group">
                                <label for="password">Password:</label>
                                <input type="password" id="password" name="password" placeholder="FARM123@#" required>
                            </div>
                            <div id="loginError" class="error-msg" style="display: none;"></div>
                            <button type="submit" class="btn-login">Login</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <section class="stats-section">
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon">üìß</div>
                        <div class="stat-content">
                            <h3>TOTAL LETTERS</h3>
                            <p id="total-letters" class="stat-value">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <h3>REPLIED</h3>
                            <p id="replied-letters" class="stat-value">0</p>
                            <span id="replied-percent" class="stat-percent"></span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-content">
                            <h3>PENDING</h3>
                            <p id="pending-letters" class="stat-value">0</p>
                            <span id="pending-percent" class="stat-percent"></span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ö°</div>
                        <div class="stat-content">
                            <h3>AVG TIME</h3>
                            <p id="avg-time" class="stat-value">--</p>
                            <span class="stat-percent">days</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Warning Summary -->
            <section class="warning-summary">
                <h2>‚ö†Ô∏è DEADLINE MONITORING</h2>
                <div class="warning-cards">
                    <div class="warning-card critical">
                        <div class="warning-number" id="overdue-count">0</div>
                        <div class="warning-text">Critical (Overdue)</div>
                    </div>
                    <div class="warning-card urgent">
                        <div class="warning-number" id="due-soon-count">0</div>
                        <div class="warning-text">Due Soon (1-7 days)</div>
                    </div>
                    <div class="warning-card pending">
                        <div class="warning-number" id="pending-count">0</div>
                        <div class="warning-text">Pending (>7 days)</div>
                    </div>
                </div>
            </section>

            <!-- Recent Letters -->
            <section class="recent-letters">
                <h2>Recent Letters</h2>
                <div class="table-responsive">
                    <table class="recent-table">
                        <thead>
                            <tr>
                                <th>Letter No</th>
                                <th>Subject</th>
                                <th>Districts</th>
                                <th>Status</th>
                                <th>Deadline</th>
                                <th>Reply Date</th>
                            </tr>
                        </thead>
                        <tbody id="recent-letters-body">
                            <tr><td colspan="6" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2026 Tripura Rural Livelihood Mission | Government of Tripura</p>
        </footer>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-box {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-saffron) 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-navy);
        }

        .form-group input {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid var(--border-gray);
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-saffron);
            box-shadow: 0 0 0 3px rgba(255, 153, 51, 0.1);
        }

        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }

        .btn-login {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-saffron) 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn-login:hover {
            opacity: 0.9;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .warning-summary {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .warning-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .warning-card {
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            color: white;
        }

        .warning-card.critical {
            background: #DC3545;
        }

        .warning-card.urgent {
            background: #FD7E14;
        }

        .warning-card.pending {
            background: #28A745;
        }

        .warning-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .recent-letters {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .table-responsive {
            overflow-x: auto;
        }

        .recent-table {
            width: 100%;
            border-collapse: collapse;
        }

        .recent-table thead {
            background: var(--primary-navy);
            color: white;
        }

        .recent-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .recent-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-gray);
        }

        .stats-section {
            padding: 2rem;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .stat-icon {
            font-size: 2.5rem;
        }

        .stat-content h3 {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-navy);
            margin: 0;
        }

        .stat-percent {
            font-size: 0.9rem;
            color: var(--success-green);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .status-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-fast {
            background-color: #C6EFCE;
            color: #006100;
        }

        .status-on-time {
            background-color: #BDD7EE;
            color: #002060;
        }

        .status-late {
            background-color: #FFC7CE;
            color: #9C0006;
        }

        .status-waiting {
            background-color: #FFEB9C;
            color: #9C6500;
        }

        .modal-overlay.show {
            display: flex !important;
        }
    </style>

    <script>
        const API_URL = '/api';

        // Calculate status based on dates
        function calculateStatus(despatchDate, deadline, replyDate) {
            if (!replyDate) return 'Waiting';
            
            const despatch = new Date(despatchDate);
            const reply = new Date(replyDate);
            const dead = new Date(deadline);
            
            const responseTime = Math.ceil((reply - despatch) / (1000 * 60 * 60 * 24));
            
            if (responseTime <= 3) return 'Fast';
            if (reply <= dead) return 'On Time';
            return 'Late';
        }

        // Get status color class
        function getStatusColor(status) {
            const statusMap = {
                'Fast': 'status-fast',
                'On Time': 'status-on-time',
                'Late': 'status-late',
                'Waiting': 'status-waiting'
            };
            return statusMap[status] || 'status-waiting';
        }

        // Modal functions
        function openLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'flex';
            modal.classList.add('show');
            setTimeout(() => {
                const username = document.getElementById('username');
                if (username) username.focus();
            }, 100);
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            const form = document.getElementById('loginForm');
            if (form) form.reset();
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) errorDiv.style.display = 'none';
        }

        // Close modal when clicking on background
        window.addEventListener('load', () => {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'loginModal') {
                        closeLoginModal();
                    }
                });
            }
        });

        // Handle login
        async function submitLogin(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter both username and password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                errorDiv.style.display = 'none';
                console.log('Attempting login with:', username);

                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    errorDiv.textContent = data.error || 'Login failed: ' + response.statusText;
                    errorDiv.style.display = 'block';
                    return;
                }

                if (data.success && data.token) {
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('username', data.username);
                    console.log('Login successful, token saved');
                    
                    closeLoginModal();
                    alert('‚úÖ Login successful! Redirecting to admin panel...');

                    setTimeout(() => {
                        window.location.href = '/pages/admin.html';
                    }, 500);
                } else {
                    errorDiv.textContent = 'Invalid response from server';
                    errorDiv.style.display = 'block';
                }

            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        // Logout function
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('username');
                location.reload();
            }
        }

        // Check if logged in and update UI
        function checkLoginStatus() {
            const token = localStorage.getItem('auth_token');
            const loginBtn = document.getElementById('login-btn');
            const adminMenu = document.getElementById('admin-menu');
            
            if (token && loginBtn && adminMenu) {
                loginBtn.style.display = 'none';
                adminMenu.style.display = 'flex';
            } else {
                if (loginBtn) loginBtn.style.display = 'block';
                if (adminMenu) adminMenu.style.display = 'none';
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                console.log('Loading dashboard data...');
                
                const response = await fetch(`${API_URL}/analytics/dashboard`);
                const data = await response.json();
                console.log('Dashboard data:', data);

                if (data.statistics) {
                    const { statistics, warnings } = data;
                    const totalLetters = statistics.total_letters || 0;
                    const repliedLetters = statistics.replied_letters || 0;
                    const pendingLetters = statistics.pending_letters || 0;

                    document.getElementById('total-letters').textContent = totalLetters;
                    document.getElementById('replied-letters').textContent = repliedLetters;
                    document.getElementById('pending-letters').textContent = pendingLetters;

                    if (totalLetters > 0) {
                        const repliedPercent = ((repliedLetters / totalLetters) * 100).toFixed(1);
                        const pendingPercent = ((pendingLetters / totalLetters) * 100).toFixed(1);
                        document.getElementById('replied-percent').textContent = `(${repliedPercent}%)`;
                        document.getElementById('pending-percent').textContent = `(${pendingPercent}%)`;
                    }

                    document.getElementById('overdue-count').textContent = warnings.overdue || 0;
                    document.getElementById('due-soon-count').textContent = warnings.due_soon || 0;
                    document.getElementById('pending-count').textContent = warnings.pending || 0;
                }

                // Load recent letters
                console.log('Loading recent letters...');
                const lettersRes = await fetch(`${API_URL}/letters?limit=10&page=1`);
                const lettersData = await lettersRes.json();
                console.log('Letters data:', lettersData);

                const tbody = document.getElementById('recent-letters-body');
                tbody.innerHTML = '';

                if (lettersData.data && lettersData.data.length > 0) {
                    lettersData.data.forEach(letter => {
                        const status = calculateStatus(
                            letter.date_of_despatch,
                            letter.deadline,
                            letter.date_of_reply
                        );
                        const statusClass = getStatusColor(status || 'Waiting');
                        const districts = letter.districts ? letter.districts.split(',').join(', ') : 'N/A';
                        const replyDate = letter.date_of_reply || '-';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${letter.letter_number || '-'}</strong></td>
                            <td>${letter.subject || '-'}</td>
                            <td><small>${districts}</small></td>
                            <td><span class="status-badge ${statusClass}">${status || 'Waiting'}</span></td>
                            <td>${letter.deadline || '-'}</td>
                            <td>${replyDate}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">No letters found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                const tbody = document.getElementById('recent-letters-body');
                tbody.innerHTML = `<tr><td colspan="6" class="loading">Error loading data: ${error.message}</td></tr>`;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...');
            checkLoginStatus();
            loadDashboard();
        });
    </script>
</body>
</html>
